const firebaseConfig={
    apiKey:"AIzaSyD39A_6XKc6Ps4woqhStPO0ym6huCq2wW8",
    authDomain:"mafia-yakuza.firebaseapp.com",
    projectId:"mafia-yakuza"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let autorizado=false;
let cargosMap={};
let membrosData=[];

// Navegação
function show(id, btn){
    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    if(id === "historico"){ // Historico não precisa de login, mas o conteúdo é restrito
        document.getElementById('historico').style.display = 'block';
        if(autorizado) {
            refreshHistorico();
        } else {
            document.getElementById('listaHistorico').innerHTML = '<div class="mensagem-restrita">Acesso restrito: apenas líderes podem visualizar esta área.</div>';
        }
    } else {
        document.getElementById(id).style.display = "block";
    }
    
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}

// Login
function login(){
    // ATENÇÃO: SENHA HARDCODED NO CÓDIGO É INSEGURO!
    if(senha.value==="yakuzanotopo2526"){
        autorizado=true;
        alert("Edição ativada!");
        document.getElementById('formMembros').style.display='block';
        document.getElementById('formCargos').style.display='block';
        document.getElementById('formCronograma').style.display='block';
        refreshData();
        // Se estiver no histórico, recarrega após o login
        if(document.getElementById('historico').style.display === 'block') refreshHistorico(); 
    }else alert("Senha incorreta");
}

// Histórico
function addHistorico(acao){
    db.collection("historico").add({acao, data: new Date()});
}

function refreshHistorico(){
    if(!autorizado) return;
    // Pega os 50 itens mais recentes
    db.collection("historico").orderBy("data", "desc").limit(50).onSnapshot(snap=>{
        let html='';
        snap.forEach(doc=>{
            let d = doc.data();
            const dataHora = d.data.toDate().toLocaleString('pt-BR');
            html+=`<div>**[${dataHora}]** ${d.acao}</div>`;
        });
        listaHistorico.innerHTML=html;
    });
}

// Cargos
function addCargo(){
    if(!autorizado) return alert("Sem permissão");
    const nomeVal = novoCargo.value.trim();
    if(!nomeVal) return alert("Preencha o cargo");
    db.collection("cargos").add({nome: nomeVal, cor: corCargo.value})
        .then(()=>{
            addHistorico(`Cargo **${nomeVal}** adicionado`);
            novoCargo.value="";
            refreshCargos(); 
        });
}

function delCargo(id,nome){
    if(!autorizado) return;
    if(confirm("Remover cargo "+nome+"?")){
        db.collection("cargos").doc(id).delete();
        addHistorico(`Cargo **${nome}** removido`);
        refreshCargos();
    }
}

function updateCargo(id,campo,valor,nome){
    if(!autorizado) return;
    db.collection("cargos").doc(id).update({[campo]:valor});
    addHistorico(`Cargo **${nome}** alterado: ${campo} → ${valor}`);
}

// Atualiza select de cargos e lista
function refreshCargos(){
    db.collection("cargos").onSnapshot(snap=>{
        cargosMap={};
        let options='<option value="">Selecione cargo</option>';
        let htmlCargos='';
        snap.forEach(doc=>{
            let d=doc.data();
            cargosMap[d.nome]=d.cor;
            options+=`<option value="${d.nome}">${d.nome}</option>`;
            htmlCargos+=autorizado? `<div><span contenteditable="true" onblur="updateCargo('${doc.id}','nome',this.innerText,'${d.nome}')">${d.nome}</span> <input type="color" class="color-picker" value="${d.cor}" onchange="updateCargo('${doc.id}','cor',this.value,'${d.nome}')"> <button class="action" onclick="delCargo('${doc.id}','${d.nome}')">Excluir</button></div>` : `<div>${d.nome} <div style="display:inline-block;width:20px;height:20px;background:${d.cor};margin-left:5px;"></div></div>`;
        });
        cargoSelect.innerHTML=options;
        listaCargos.innerHTML=htmlCargos;
    });
}

// Adicionar Membro
function addMembro() {
    if (!autorizado) return alert("Sem permissão");

    const nomeVal = document.getElementById("nome").value.trim();
    const cargoVal = document.getElementById("cargoSelect").value;

    if(!nomeVal) return alert("Digite o nome do membro");
    if(!cargoVal) return alert("Selecione o cargo");
    
    // Define um valor de 'order' que será o tamanho atual da lista + 1
    const newOrder = membrosData.length > 0 ? membrosData[membrosData.length - 1].order + 1 : 0;

    db.collection("membros").add({
        nome: nomeVal, 
        cargo: cargoVal, 
        punicao: 0, 
        pontos: 0,
        order: newOrder // Novo campo para ordenação
    })
    .then(()=>{
        document.getElementById("nome").value=""; 
        document.getElementById("cargoSelect").value=""; 
        addHistorico(`Membro **${nomeVal}** adicionado com cargo **${cargoVal}**`);
    });
}

// Atualiza todos os dados
function refreshData(){
    refreshCargos();
    refreshCronograma();
    refreshMembros();
}

function refreshMembros(){
    // Adicionado orderBy('order') para garantir a ordem persistente
    db.collection("membros").orderBy("order").onSnapshot(snap=>{
        membrosData=[];
        snap.forEach(doc=>{
            membrosData.push({id:doc.id,...doc.data()});
        });
        renderMembros();
        renderPunicoes();
        renderPontuacao();
    });
}

function renderMembros(){
    let html='';
    membrosData.forEach((m)=>{
        let cor = cargosMap[m.cargo]||'#0b1625';
        html+=`<div style="background:${cor};padding:5px;border-radius:5px;">
        <span contenteditable="${autorizado}" onblur="updateCampo('membros','${m.id}','nome',this.innerText)">${m.nome}</span> - 
        <span contenteditable="${autorizado}" onblur="updateCampo('membros','${m.id}','cargo',this.innerText)">${m.cargo}</span>
        ${autorizado?`<button class="action" onclick="delMembro('${m.id}','${m.nome}')">Excluir</button>`:''}
        ${autorizado?`<button class="action drag-button" onclick="moveMembro('${m.id}','up')">↑</button><button class="action drag-button" onclick="moveMembro('${m.id}','down')">↓</button>`:''}
        </div>`;
    });
    listaMembros.innerHTML=html;
}

function moveMembro(id,direction){
    if(!autorizado) return;
    let index = membrosData.findIndex(m=>m.id===id);
    if(index === -1) return;

    let targetIndex = -1;
    
    if(direction==='up' && index>0){
        targetIndex = index - 1;
    } else if(direction==='down' && index<membrosData.length-1){
        targetIndex = index + 1;
    }
    
    if(targetIndex !== -1){
        // 1. Troca a ordem no array local para renderização imediata
        let temp = membrosData[targetIndex];
        membrosData[targetIndex] = membrosData[index];
        membrosData[index] = temp;
        
        // 2. Atualiza a ordem no Firestore
        const currentOrder = membrosData[index].order;
        const targetOrder = membrosData[targetIndex].order;
        
        // Aplica a nova ordem no Firestore (garantindo que os dados sejam salvos)
        db.collection('membros').doc(membrosData[index].id).update({order: targetOrder});
        db.collection('membros').doc(membrosData[targetIndex].id).update({order: currentOrder});
        
        addHistorico(`Ordem do membro **${membrosData[index].nome}** alterada.`);
    }
    // Re-renderiza localmente para feedback imediato (será sobreposto pelo onSnapshot)
    renderMembros();
}

function delMembro(id, nome){
    if(!autorizado) return;
    if(confirm(`Excluir membro ${nome}?`)){
        db.collection("membros").doc(id).delete();
        addHistorico(`Membro **${nome}** excluído.`);
    }
}

function updateCampo(collection,id,campo,valor){
    if(!autorizado) return;
    let val = isNaN(valor) || valor === '' ? valor : Number(valor);
    db.collection(collection).doc(id).update({[campo]:val});
    addHistorico(`Membro/Dados atualizados em **${collection}**: ${campo} → **${valor}**`);
}

// Função para alterar pontos e punições via botões
function changeValue(id, campo, delta){
    if(!autorizado) return;
    let membro = membrosData.find(m=>m.id===id);
    if(!membro) return;
    let novo = membro[campo]+delta;
    
    let acaoHistorico = '';
    
    if(campo==='punicao'){
        novo=Math.max(0,Math.min(3,novo));
        acaoHistorico = novo > membro.punicao ? 'punição adicionada' : 'punição removida';
    } else if(campo==='pontos'){
        novo=Math.max(0,Math.min(10,novo));
        acaoHistorico = novo > membro.pontos ? 'pontos adicionados' : 'pontos removidos';
    }
    
    updateCampo('membros',id,campo,novo);
    addHistorico(`${membro.nome}: ${acaoHistorico}. Novo valor de ${campo}: **${novo}**`);
}

// Punicoes
function renderPunicoes(){
    let html='';
    membrosData.forEach(m=>{
        let cor='';
        switch(m.punicao){
            case 0: cor='green'; break;
            case 1: cor='yellow'; break;
            case 2: cor='orange'; break;
            case 3: cor='red'; break;
        }
        let nomeDisplay = (m.punicao>=3)?`${m.nome} (Banido)`:m.nome;
        html+=`<div style="background:${cor};padding:5px;border-radius:5px;">
        ${nomeDisplay} (${m.cargo}) → 
        <span>${m.punicao}</span>
        ${autorizado?`<button class="action" onclick="changeValue('${m.id}','punicao',1)">+</button><button class="action" onclick="changeValue('${m.id}','punicao',-1)">-</button>`:''}
        </div>`;
    });
    listaPunicoes.innerHTML=html;
}

// Pontuação
function renderPontuacao(){
    let html='';
    membrosData.forEach(m=>{
        let cor='';
        if(m.pontos<=3) cor='red';
        else if(m.pontos<=6) cor='yellow';
        else cor='green';
        html+=`<div style="background:${cor};padding:5px;border-radius:5px;">
        ${m.nome} (${m.cargo}) → 
        <span>${m.pontos}</span>
        ${autorizado?`<button class="action" onclick="changeValue('${m.id}','pontos',1)">+</button><button class="action" onclick="changeValue('${m.id}','pontos',-1)">-</button>`:''}
        </div>`;
    });
    listaPontuacao.innerHTML=html;
}

// Cronograma
function addCronograma(){
    if(!autorizado) return alert("Sem permissão");
    let titulo = tituloCronograma.value.trim();
    let acao = acaoCronograma.value.trim();
    let numero = Number(numeroCronograma.value);
    let corT = corTitulo.value;
    let corA = corAcao.value;
    let corN = corNumero.value;
    if(!titulo || !acao) return alert("Preencha cronograma e ação");
    db.collection("cronograma").add({titulo,acao,numero,corTitulo:corT,corAcao:corA,corNumero:corN})
        .then(()=>addHistorico(`Cronograma adicionado: **${titulo} | ${acao} | ${numero}**`));
}

function delCronograma(id, titulo){
    if(!autorizado) return;
    if(confirm("Remover esta entrada do cronograma?")){
        db.collection("cronograma").doc(id).delete();
        addHistorico(`Cronograma **${titulo}** removido`);
    }
}

function updateCronograma(id,campo,valor){
    if(!autorizado) return;
    db.collection("cronograma").doc(id).update({[campo]:valor});
    addHistorico(`Cronograma atualizado: ${campo} → **${valor}**`);
}

function refreshCronograma(){
    db.collection("cronograma").onSnapshot(snap=>{
        // Adiciona o cabeçalho fora do loop de dados
        let html=`
            <div class="cronograma-container">
                <div class="cronograma-cell cronograma-header">Cronograma</div>
                <div class="cronograma-cell cronograma-header">Ação</div>
                <div class="cronograma-cell cronograma-header">Número</div>
                <div class="cronograma-cell cronograma-header">Ações</div>
        `;
        snap.forEach(doc=>{
            let d=doc.data();
            html+=`
            <div class="cronograma-cell" style="background:${d.corTitulo}"><span contenteditable="${autorizado}" onblur="updateCronograma('${doc.id}','titulo',this.innerText)">${d.titulo}</span></div>
            <div class="cronograma-cell" style="background:${d.corAcao}"><span contenteditable="${autorizado}" onblur="updateCronograma('${doc.id}','acao',this.innerText)">${d.acao}</span></div>
            <div class="cronograma-cell" style="background:${d.corNumero}"><input type="number" class="cronograma-input" value="${d.numero}" min="0" max="20" ${autorizado?`onchange="updateCronograma('${doc.id}','numero',this.value)"`:''}></div>
            <div class="cronograma-cell">${autorizado?`<button class="action" onclick="delCronograma('${doc.id}', '${d.titulo}')">Excluir</button>`:''}</div>
            `;
        });
        html+='</div>';
        listaCronograma.innerHTML=html;
    });
}

// Inicial
show("login",document.querySelector("nav button"));
refreshData();
