<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mafia Yakuza</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
Â  --bg:#050b14;
Â  --panel:#0b1625;
Â  --blue:#1f6feb;
Â  --blue-dark:#0a3d91;
Â  --text:#ffffff;
}
body{
Â  margin:0;
Â  font-family:Arial, Helvetica, sans-serif;
Â  background:var(--bg);
Â  color:var(--text);
}
header{
Â  background:var(--panel);
Â  padding:15px;
Â  display:flex;
Â  align-items:center;
Â  gap:15px;
}
header img{height:50px;}
nav{
Â  display:flex;
Â  background:#020814;
Â  flex-wrap: wrap;
}
nav button{
Â  flex:1;
Â  padding:15px;
Â  background:none;
Â  border:none;
Â  color:white;
Â  cursor:pointer;
Â  font-size:15px;
}
nav button.active,nav button:hover{
Â  background:var(--blue);
}
section{
Â  display:none;
Â  padding:20px;
}
input, select{
Â  padding:8px;
Â  margin:5px;
Â  border-radius:5px;
Â  border:none;
}
button.action{
Â  background:var(--blue);
Â  border:none;
Â  color:white;
Â  padding:5px 10px;
Â  cursor:pointer;
Â  margin-left:5px;
}
button.action:hover{background:var(--blue-dark);}
.color-picker{width:40px;height:25px;border:none;cursor:pointer;vertical-align: middle;}
.mensagem-restrita{
Â  text-align:center;
Â  font-size:18px;
Â  color:#c9c9c9;
Â  padding:50px 0;
Â  font-weight:bold;
Â  border:2px dashed #555;
Â  border-radius:10px;
Â  background:#0b1625;
}
.member-container div{margin:5px 0;}
.red{background:#9b1c1c}
.yellow{background:#c9a227;color:black}
.orange{background:#e67e22;color:black}
.green{background:#137333}

/* Cronograma estilo planilha */
.cronograma-container{
Â  display:grid;
Â  grid-template-columns: 2fr 5fr 1fr 1fr;
Â  gap:5px;
Â  margin-top:10px;
}
.cronograma-header{
Â  font-weight:bold;
Â  text-align:center;
Â  text-transform:uppercase;
Â  background:#0b1625;
Â  border:1px solid #1f2a44;
Â  padding:8px;
Â  border-radius:5px;
}
.cronograma-cell{
Â  padding:8px;
Â  border:1px solid #1f2a44;
Â  border-radius:5px;
Â  min-height:35px;
Â  display:flex;
Â  align-items:center;
Â  justify-content:center;
Â  font-weight:bold;
Â  color:white;
Â  transition: background 0.3s;
}
.cronograma-input{
Â  width:100%;
Â  border:none;
Â  background:transparent;
Â  text-align:center;
Â  font-weight:bold;
Â  color:white;
}
.drag-button{
Â  cursor:pointer;
Â  margin-left:5px;
}
</style>
</head>

<body>

<header>
Â  <img src="logo.png">
Â  <h2>MÃ¡fia Yakuza</h2>
</header>

<nav>
Â  <button onclick="show('login',this)">Login</button>
Â  <button onclick="show('membros',this)">Membros</button>
Â  <button onclick="show('punicoes',this)">PuniÃ§Ãµes</button>
Â  <button onclick="show('pontuacao',this)">PontuaÃ§Ã£o</button>
Â  <button onclick="show('cargos',this)">Cargos</button>
Â  <button onclick="show('cronograma',this)">Cronograma</button>
Â  <button onclick="show('historico',this)">HistÃ³rico</button>
</nav>

<section id="login">
Â  <h3>ðŸ”’ PermissÃ£o de ediÃ§Ã£o</h3>
Â  <input type="password" id="senha" placeholder="Senha">
Â  <button class="action" onclick="login()">Ativar ediÃ§Ã£o</button>
</section>

<section id="membros">
Â  <h3>Membros</h3>
Â  <div id="formMembros" style="display:none">
Â  Â  <input id="nome" placeholder="Nome">
Â  Â  <select id="cargoSelect"><option value="">Selecione cargo</option></select>
Â  Â  <button class="action" onclick="addMembro()">Adicionar Membro</button>
Â  </div>
Â  <div id="listaMembros" class="member-container"></div>
</section>

<section id="punicoes">
Â  <h3>PuniÃ§Ãµes</h3>
Â  <div id="listaPunicoes" class="member-container"></div>
</section>

<section id="pontuacao">
Â  <h3>PontuaÃ§Ã£o</h3>
Â  <div id="listaPontuacao" class="member-container"></div>
</section>

<section id="cargos">
Â  <h3>Cargos</h3>
Â  <div id="formCargos" style="display:none">
Â  Â  <input id="novoCargo" placeholder="Nome do cargo">
Â  Â  <input type="color" id="corCargo" value="#1f6feb">
Â  Â  <button class="action" onclick="addCargo()">Adicionar Cargo</button>
Â  </div>
Â  <div id="listaCargos"></div>
</section>

<section id="cronograma">
Â  <h3>Cronograma</h3>
Â  <div id="formCronograma" style="display:none">
Â  Â  <input id="tituloCronograma" placeholder="Cronograma">
Â  Â  <input id="acaoCronograma" placeholder="AÃ§Ã£o">
Â  Â  <input type="number" id="numeroCronograma" value="0" min="0" max="20">
Â  Â  <input type="color" id="corTitulo" value="#0b1625" title="Cor do Cronograma">
Â  Â  <input type="color" id="corAcao" value="#0b1625" title="Cor da AÃ§Ã£o">
Â  Â  <input type="color" id="corNumero" value="#1f6feb" title="Cor do NÃºmero">
Â  Â  <button class="action" onclick="addCronograma()">Adicionar</button>
Â  </div>
Â  <div id="listaCronograma" class="cronograma-container"></div>
</section>

<section id="historico">
Â  <h3>HistÃ³rico de alteraÃ§Ãµes</h3>
Â  <div id="listaHistorico"></div>
</section>

<script>
const firebaseConfig={
    apiKey:"AIzaSyD39A_6XKc6Ps4woqhStPO0ym6huCq2wW8",
    authDomain:"mafia-yakuza.firebaseapp.com",
    projectId:"mafia-yakuza"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let autorizado=false;
let cargosMap={};
let membrosData=[];

// NavegaÃ§Ã£o
function show(id, btn){
    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    if(id === "historico"){
        document.getElementById('historico').style.display = 'block';
        if(autorizado) {
            refreshHistorico();
        } else {
            document.getElementById('listaHistorico').innerHTML = '<div class="mensagem-restrita">Acesso restrito: apenas lÃ­deres podem visualizar esta Ã¡rea.</div>';
        }
    } else {
        document.getElementById(id).style.display = "block";
    }
    
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}

// Login
function login(){
    if(senha.value==="yakuzanotopo2526"){
        autorizado=true;
        alert("EdiÃ§Ã£o ativada!");
        document.getElementById('formMembros').style.display='block';
        document.getElementById('formCargos').style.display='block';
        document.getElementById('formCronograma').style.display='block';
        refreshData();
        if(document.getElementById('historico').style.display === 'block') refreshHistorico(); 
    }else alert("Senha incorreta");
}

// HistÃ³rico
function addHistorico(acao){
    db.collection("historico").add({acao, data: new Date()});
}

function refreshHistorico(){
    if(!autorizado) return;
    db.collection("historico").orderBy("data", "desc").limit(50).onSnapshot(snap=>{
        let html='';
        snap.forEach(doc=>{
            let d = doc.data();
            const dataHora = d.data.toDate().toLocaleString('pt-BR');
            html+=`<div>**[${dataHora}]** ${d.acao}</div>`;
        });
        listaHistorico.innerHTML=html;
    });
}

// Cargos
function addCargo(){
    if(!autorizado) return alert("Sem permissÃ£o");
    const nomeVal = novoCargo.value.trim();
    if(!nomeVal) return alert("Preencha o cargo");
    db.collection("cargos").add({nome: nomeVal, cor: corCargo.value})
        .then(()=>{
            addHistorico(`Cargo **${nomeVal}** adicionado`);
            novoCargo.value="";
            refreshCargos(); 
        });
}

function delCargo(id,nome){
    if(!autorizado) return;
    if(confirm("Remover cargo "+nome+"?")){
        db.collection("cargos").doc(id).delete();
        addHistorico(`Cargo **${nome}** removido`);
        refreshCargos();
    }
}

function updateCargo(id,campo,valor,nome){
    if(!autorizado) return;
    db.collection("cargos").doc(id).update({[campo]:valor});
    addHistorico(`Cargo **${nome}** alterado: ${campo} â†’ ${valor}`);
}

// Atualiza select de cargos e lista
function refreshCargos(){
    db.collection("cargos").onSnapshot(snap=>{
        cargosMap={};
        let options='<option value="">Selecione cargo</option>';
        let htmlCargos='';
        snap.forEach(doc=>{
            let d=doc.data();
            cargosMap[d.nome]=d.cor;
            options+=`<option value="${d.nome}">${d.nome}</option>`;
            htmlCargos+=autorizado? `<div><span contenteditable="true" onblur="updateCargo('${doc.id}','nome',this.innerText,'${d.nome}')">${d.nome}</span> <input type="color" class="color-picker" value="${d.cor}" onchange="updateCargo('${doc.id}','cor',this.value,'${d.nome}')"> <button class="action" onclick="delCargo('${doc.id}','${d.nome}')">Excluir</button></div>` : `<div>${d.nome} <div style="display:inline-block;width:20px;height:20px;background:${d.cor};margin-left:5px;"></div></div>`;
        });
        cargoSelect.innerHTML=options;
        listaCargos.innerHTML=htmlCargos;
    });
}

// Adicionar Membro
function addMembro() {
    if (!autorizado) return alert("Sem permissÃ£o");

    const nomeVal = document.getElementById("nome").value.trim();
    const cargoVal = document.getElementById("cargoSelect").value;

    if(!nomeVal) return alert("Digite o nome do membro");
    if(!cargoVal) return alert("Selecione o cargo");
    
    // Define a ordem: Ãºltimo valor de ordem + 1
    const newOrder = membrosData.length > 0 ? membrosData[membrosData.length - 1].order + 1 : 0;

    db.collection("membros").add({
        nome: nomeVal, 
        cargo: cargoVal, 
        punicao: 0, 
        pontos: 0,
        order: newOrder // Campo de ordenaÃ§Ã£o
    })
    .then(()=>{
        document.getElementById("nome").value=""; 
        document.getElementById("cargoSelect").value=""; 
        addHistorico(`Membro **${nomeVal}** adicionado com cargo **${cargoVal}**`);
    });
}

// Atualiza todos os dados
function refreshData(){
    refreshCargos();
    refreshCronograma();
    refreshMembros();
}

function refreshMembros(){
    // Ordena por "order" para manter a ordem definida pelos botÃµes
    db.collection("membros").orderBy("order").onSnapshot(snap=>{
        membrosData=[];
        snap.forEach(doc=>{
            membrosData.push({id:doc.id,...doc.data()});
        });
        renderMembros();
        renderPunicoes();
        renderPontuacao();
    });
}

function renderMembros(){
    let html='';
    membrosData.forEach((m)=>{
        let cor = cargosMap[m.cargo]||'#0b1625';
        html+=`<div style="background:${cor};padding:5px;border-radius:5px;">
        <span contenteditable="${autorizado}" onblur="updateCampo('membros','${m.id}','nome',this.innerText)">${m.nome}</span> - 
        <span contenteditable="${autorizado}" onblur="updateCampo('membros','${m.id}','cargo',this.innerText)">${m.cargo}</span>
        ${autorizado?`<button class="action" onclick="delMembro('${m.id}','${m.nome}')">Excluir</button>`:''}
        ${autorizado?`<button class="action drag-button" onclick="moveMembro('${m.id}','up')">â†‘</button><button class="action drag-button" onclick="moveMembro('${m.id}','down')">â†“</button>`:''}
        </div>`;
    });
    listaMembros.innerHTML=html;
}

function moveMembro(id,direction){
    if(!autorizado) return;
    let index = membrosData.findIndex(m=>m.id===id);
    if(index === -1) return;

    let targetIndex = -1;
    
    if(direction==='up' && index>0){
        targetIndex = index - 1;
    } else if(direction==='down' && index<membrosData.length-1){
        targetIndex = index + 1;
    }
    
    if(targetIndex !== -1){
        // 1. Troca a ordem no array local
        let temp = membrosData[targetIndex];
        membrosData[targetIndex] = membrosData[index];
        membrosData[index] = temp;
        
        // 2. Salva a nova ordem no Firestore
        const currentOrder = membrosData[index].order;
        const targetOrder = membrosData[targetIndex].order;
        
        db.collection('membros').doc(membrosData[index].id).update({order: targetOrder});
        db.collection('membros').doc(membrosData[targetIndex].id).update({order: currentOrder});
        
        addHistorico(`Ordem do membro **${membrosData[index].nome}** alterada.`);
    }
    renderMembros();
}

function delMembro(id, nome){
    if(!autorizado) return;
    if(confirm(`Excluir membro ${nome}?`)){
        db.collection("membros").doc(id).delete();
        addHistorico(`Membro **${nome}** excluÃ­do.`);
    }
}

function updateCampo(collection,id,campo,valor){
    if(!autorizado) return;
    let val = isNaN(valor) || valor === '' ? valor : Number(valor);
    db.collection(collection).doc(id).update({[campo]:val});
    addHistorico(`Membro/Dados atualizados em **${collection}**: ${campo} â†’ **${valor}**`);
}

// FunÃ§Ã£o para alterar pontos e puniÃ§Ãµes via botÃµes
function changeValue(id, campo, delta){
    if(!autorizado) return;
    let membro = membrosData.find(m=>m.id===id);
    if(!membro) return;
    let novo = membro[campo]+delta;
    
    let acaoHistorico = '';
    
    if(campo==='punicao'){
        novo=Math.max(0,Math.min(3,novo));
        acaoHistorico = novo > membro.punicao ? 'puniÃ§Ã£o adicionada' : 'puniÃ§Ã£o removida';
    } else if(campo==='pontos'){
        novo=Math.max(0,Math.min(10,novo));
        acaoHistorico = novo > membro.pontos ? 'pontos adicionados' : 'pontos removidos';
    }
    
    updateCampo('membros',id,campo,novo);
    addHistorico(`${membro.nome}: ${acaoHistorico}. Novo valor de ${campo}: **${novo}**`);
}

// Punicoes
function renderPunicoes(){
    let html='';
    membrosData.forEach(m=>{
        let cor='';
        switch(m.punicao){
            case 0: cor='green'; break;
            case 1: cor='yellow'; break;
            case 2: cor='orange'; break;
            case 3: cor='red'; break;
        }
        let nomeDisplay = (m.punicao>=3)?`${m.nome} (Banido)`:m.nome;
        html+=`<div style="background:${cor};padding:5px;border-radius:5px;">
        ${nomeDisplay} (${m.cargo}) â†’ 
        <span>${m.punicao}</span>
        ${autorizado?`<button class="action" onclick="changeValue('${m.id}','punicao',1)">+</button><button class="action" onclick="changeValue('${m.id}','punicao',-1)">-</button>`:''}
        </div>`;
    });
    listaPunicoes.innerHTML=html;
}

// PontuaÃ§Ã£o
function renderPontuacao(){
    let html='';
    membrosData.forEach(m=>{
        let cor='';
        if(m.pontos<=3) cor='red';
        else if(m.pontos<=6) cor='yellow';
        else cor='green';
        html+=`<div style="background:${cor};padding:5px;border-radius:5px;">
        ${m.nome} (${m.cargo}) â†’ 
        <span>${m.pontos}</span>
        ${autorizado?`<button class="action" onclick="changeValue('${m.id}','pontos',1)">+</button><button class="action" onclick="changeValue('${m.id}','pontos',-1)">-</button>`:''}
        </div>`;
    });
    listaPontuacao.innerHTML=html;
}

// Cronograma
function addCronograma(){
    if(!autorizado) return alert("Sem permissÃ£o");
    let titulo = tituloCronograma.value.trim();
    let acao = acaoCronograma.value.trim();
    let numero = Number(numeroCronograma.value);
    let corT = corTitulo.value;
    let corA = corAcao.value;
    let corN = corNumero.value;
    if(!titulo || !acao) return alert("Preencha cronograma e aÃ§Ã£o");
    db.collection("cronograma").add({titulo,acao,numero,corTitulo:corT,corAcao:corA,corNumero:corN})
        .then(()=>addHistorico(`Cronograma adicionado: **${titulo} | ${acao} | ${numero}**`));
}

function delCronograma(id, titulo){
    if(!autorizado) return;
    if(confirm("Remover esta entrada do cronograma?")){
        db.collection("cronograma").doc(id).delete();
        addHistorico(`Cronograma **${titulo}** removido`);
    }
}

function updateCronograma(id,campo,valor){
    if(!autorizado) return;
    db.collection("cronograma").doc(id).update({[campo]:valor});
    addHistorico(`Cronograma atualizado: ${campo} â†’ **${valor}**`);
}

function refreshCronograma(){
    db.collection("cronograma").onSnapshot(snap=>{
        let html=`
            <div class="cronograma-container">
                <div class="cronograma-cell cronograma-header">Cronograma</div>
                <div class="cronograma-cell cronograma-header">AÃ§Ã£o</div>
                <div class="cronograma-cell cronograma-header">NÃºmero</div>
                <div class="cronograma-cell cronograma-header">AÃ§Ãµes</div>
        `;
        snap.forEach(doc=>{
            let d=doc.data();
            html+=`
            <div class="cronograma-cell" style="background:${d.corTitulo}"><span contenteditable="${autorizado}" onblur="updateCronograma('${doc.id}','titulo',this.innerText)">${d.titulo}</span></div>
            <div class="cronograma-cell" style="background:${d.corAcao}"><span contenteditable="${autorizado}" onblur="updateCronograma('${doc.id}','acao',this.innerText)">${d.acao}</span></div>
            <div class="cronograma-cell" style="background:${d.corNumero}"><input type="number" class="cronograma-input" value="${d.numero}" min="0" max="20" ${autorizado?`onchange="updateCronograma('${doc.id}','numero',this.value)"`:''}></div>
            <div class="cronograma-cell">${autorizado?`<button class="action" onclick="delCronograma('${doc.id}', '${d.titulo}')">Excluir</button>`:''}</div>
            `;
        });
        html+='</div>';
        listaCronograma.innerHTML=html;
    });
}

// Inicial
show("login",document.querySelector("nav button"));
refreshData();
</script>

</body>
</html>
