<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mafia Yakuza</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#050b14;
  --panel:#0b1625;
  --blue:#1f6feb;
  --blue-dark:#0a3d91;
  --text:#ffffff;
}

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  background:var(--panel);
  padding:15px;
  display:flex;
  align-items:center;
  gap:15px;
}

header img{
  height:50px;
}

nav{
  display:flex;
  background:#020814;
  flex-wrap: wrap;
}

nav button{
  flex:1;
  padding:15px;
  background:none;
  border:none;
  color:white;
  cursor:pointer;
  font-size:15px;
}

nav button.active,
nav button:hover{
  background:var(--blue);
}

section{
  display:none;
  padding:20px;
}

input, select{
  padding:8px;
  margin:5px;
}

.member-card{
  padding:5px;
  margin:5px 0;
  border-radius:5px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  transition: background 0.3s;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th,td{
  border:1px solid #1f2a44;
  padding:8px;
  text-align:center;
}

td[contenteditable="true"]{
  background:#020814;
}

.red{background:#9b1c1c}
.yellow{background:#c9a227;color:black}
.green{background:#137333}

button.action{
  background:var(--blue);
  border:none;
  color:white;
  padding:5px 10px;
  cursor:pointer;
  margin-left:5px;
}
button.action:hover{
  background:var(--blue-dark);
}

.color-picker{
  width:40px;
  height:25px;
  border:none;
  cursor:pointer;
  vertical-align: middle;
}

.mensagem-restrita{
  text-align:center;
  font-size:18px;
  color:#c9c9c9;
  padding:50px 0;
  font-weight:bold;
  border:2px dashed #555;
  border-radius:10px;
  background:#0b1625;
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <h2>M√°fia Yakuza</h2>
</header>

<nav>
  <button onclick="show('login',this)">Login</button>
  <button onclick="show('membros',this)">Membros</button>
  <button onclick="show('punicoes',this)">Puni√ß√µes</button>
  <button onclick="show('pontuacao',this)">Pontua√ß√£o</button>
  <button onclick="show('cargos',this)">Cargos</button>
  <button onclick="show('historico',this)">Hist√≥rico</button>
</nav>

<section id="login">
  <h3>üîí Permiss√£o</h3>
  <input type="password" id="senha" placeholder="Senha">
  <button class="action" onclick="login()">Entrar</button>
</section>

<section id="membros">
  <h3>Membros</h3>
  <input id="nome" placeholder="Nome">
  <select id="cargoSelect"><option value="">Selecione cargo</option></select>
  <button class="action" onclick="addMembro()">Adicionar</button>
  <button class="action" onclick="exportarMembros()">Exportar Planilha</button>
  <div id="listaMembros"></div>
</section>

<section id="punicoes">
  <h3>Puni√ß√µes</h3>
  <div id="listaPunicoes"></div>
</section>

<section id="pontuacao">
  <h3>Pontua√ß√£o</h3>
  <div id="listaPontuacao"></div>
</section>

<section id="cargos">
  <h3>Cargos</h3>
  <input id="novoCargo" placeholder="Nome do cargo">
  <input type="color" id="corCargo" value="#1f6feb">
  <button class="action" onclick="addCargo()">Adicionar Cargo</button>
  <div id="listaCargos"></div>
</section>

<section id="historico">
  <h3>Hist√≥rico de altera√ß√µes</h3>
  <div id="listaHistorico"></div>
</section>

<script>
const firebaseConfig={
  apiKey:"AIzaSyD39A_6XKc6Ps4woqhStPO0ym6huCq2wW8",
  authDomain:"mafia-yakuza.firebaseapp.com",
  projectId:"mafia-yakuza"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let autorizado=false;
let cargosMap = {}; // Guarda nome -> cor

function show(id, btn){
  document.querySelectorAll("section").forEach(s => s.style.display = "none");

  if(id === "historico" && !autorizado){
    document.getElementById('historico').style.display = 'block';
    document.getElementById('listaHistorico').innerHTML = '<div class="mensagem-restrita">Acesso restrito: apenas l√≠deres e subordinados autorizados podem visualizar este conte√∫do.</div>';
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    return;
  }

  document.getElementById(id).style.display = "block";
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

function login(){
  if(senha.value==="yakuzanotopo2526"){
    autorizado=true;
    alert("Permiss√£o concedida");
    refreshData();
  }else alert("Senha incorreta");
}

function addHistorico(acao){
  db.collection("historico").add({acao,data:new Date()});
}

// Cargos
function addCargo(){
  if(!autorizado) return alert("Sem permiss√£o");
  if(!novoCargo.value) return alert("Preencha o cargo");
  db.collection("cargos").add({nome:novoCargo.value,cor:corCargo.value})
    .then(()=>addHistorico(`Cargo ${novoCargo.value} adicionado`));
}

function delCargo(id,nome){
  if(!autorizado) return;
  if(confirm("Remover cargo "+nome+"?")){
    db.collection("cargos").doc(id).delete();
    addHistorico(`Cargo ${nome} removido`);
  }
}

function updateCargo(id, campo, valor, nome){
  if(!autorizado) return;
  db.collection("cargos").doc(id).update({[campo]:valor});
  addHistorico(`Cargo ${nome} alterado: ${campo} ‚Üí ${valor}`);
}

// Membros
function addMembro(){
  if(!autorizado) return alert("Sem permiss√£o");
  let nomeVal = nome.value;
  let cargoVal = cargoSelect.value;
  if(!nomeVal || !cargoVal) return alert("Preencha nome e selecione cargo");
  db.collection("membros").add({
    nome: nomeVal,
    cargo: cargoVal,
    punicao:0,
    pontos:0
  }).then(()=>addHistorico(`Membro ${nomeVal} adicionado`));
}

function delMembro(id,nome){
  if(!autorizado) return;
  if(confirm("Excluir membro "+nome+"?")){
    db.collection("membros").doc(id).delete();
    addHistorico(`Membro ${nome} removido`);
  }
}

function updateMembro(id,campo,valor,nome,elementoCard){
  if(!autorizado) return;
  let valorFinal = campo==="punicao"||campo==="pontos"?Number(valor)||0:valor;
  db.collection("membros").doc(id).update({[campo]:valorFinal});

  // Se for cargo, atualiza a cor do card
  if(campo === "cargo" && elementoCard){
    let cor = cargosMap[valorFinal] || '#0b1625';
    elementoCard.style.background = cor;
  }

  addHistorico(`Membro ${nome} alterou ${campo} para ${valorFinal}`);
}

function color(p){
  if(p<=3)return"red";
  if(p<=6)return"yellow";
  return"green";
}

// Export CSV
function exportarMembros(){
  db.collection("membros").get().then(snap=>{
    let csv="Nome,Cargo,Puni√ß√£o,Pontos\n";
    snap.forEach(doc=>{
      let d=doc.data();
      csv+=`${d.nome},${d.cargo},${d.punicao},${d.pontos}\n`;
    });
    let blob = new Blob([csv], {type:"text/csv"});
    let link = document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="membros.csv";
    link.click();
  });
}

// Atualizar dados
function refreshData(){
  // Carregar cargos
  db.collection("cargos").onSnapshot(snap=>{
    cargosMap = {};
    let options = '<option value="">Selecione cargo</option>';
    let htmlCargos = '';
    snap.forEach(doc=>{
      let d=doc.data();
      cargosMap[d.nome] = d.cor;
      options += `<option value="${d.nome}">${d.nome}</option>`;
      htmlCargos += `<div>
        <span contenteditable="${autorizado}" onblur="updateCargo('${doc.id}','nome',this.innerText,'${d.nome}')">${d.nome}</span>
        <input type="color" class="color-picker" value="${d.cor}" onchange="updateCargo('${doc.id}','cor',this.value,'${d.nome}')">
        <button class="action" onclick="delCargo('${doc.id}','${d.nome}')">Excluir</button>
      </div>`;
    });
    cargoSelect.innerHTML = options;
    listaCargos.innerHTML = htmlCargos;
  });

  // Carregar membros
  db.collection("membros").onSnapshot(snap=>{
    let html='',pun='',pt='';
    snap.forEach(doc=>{
      let d=doc.data(),id=doc.id;
      let bg = cargosMap[d.cargo] || '#0b1625';
      if(d.punicao>=3){db.collection("membros").doc(id).delete(); return;}
      html+=`<div class="member-card" style="background:${bg}" id="member-${id}">
        <b contenteditable="${autorizado}" onblur="updateMembro('${id}','nome',this.innerText,'${d.nome}',this.parentElement)">${d.nome}</b>
        - <select ${autorizado ? '' : 'disabled'} onchange="updateMembro('${id}','cargo',this.value,'${d.nome}',this.parentElement)"></select>
        <button class="action" onclick="delMembro('${id}','${d.nome}')">Excluir</button>
      </div>`;
      pun+=`<div>${d.nome} ‚Üí 
        <span contenteditable="${autorizado}" onblur="updateMembro('${id}','punicao',this.innerText,'${d.nome}')">${d.punicao}</span>
        <button class="action" onclick="updateMembro('${id}','punicao',${d.punicao+1},'${d.nome}')">+</button>
        <button class="action" onclick="updateMembro('${id}','punicao',${d.punicao-1},'${d.nome}')">-</button>
      </div>`;
      pt+=`<div class="${color(d.pontos)}">${d.nome} ‚Üí 
        <span contenteditable="${autorizado}" onblur="updateMembro('${id}','pontos',this.innerText,'${d.nome}')">${d.pontos}</span>
        <button class="action" onclick="updateMembro('${id}','pontos',${d.pontos+1},'${d.nome}')">+</button>
        <button class="action" onclick="updateMembro('${id}','pontos',${d.pontos-1},'${d.nome}')">-</button>
      </div>`;
    });
    listaMembros.innerHTML = html;
    listaPunicoes.innerHTML = pun;
    listaPontuacao.innerHTML = pt;

    // Preencher os selects dos membros com os cargos
    Object.keys(cargosMap).forEach(cargoName=>{
      document.querySelectorAll('.member-card').forEach(card=>{
        let select = card.querySelector('select');
        if(select){
          let opt = document.createElement('option');
          opt.value = cargoName;
          opt.text = cargoName;
          select.appendChild(opt);
          if(card.querySelector('b').innerText && card.querySelector('b').innerText === cargoName){
            select.value = cargoName;
          }
          // Ajusta valor atual
          let membroCargo = card.querySelector('b').nextElementSibling ? card.querySelector('b').nextElementSibling.value : '';
          if(card.querySelector('b').nextElementSibling) card.querySelector('b').nextElementSibling.value = membroCargo;
        }
      });
    });
  });

  // Hist√≥rico
  if(autorizado){
    db.collection("historico").orderBy("data","desc").onSnapshot(snap=>{
      let html="";
      snap.forEach(doc=>{
        let d=doc.data();
        html+=`<div>${new Date(d.data.seconds*1000).toLocaleString()} ‚Üí ${d.acao}</div>`;
      });
      listaHistorico.innerHTML=html;
    });
  }
}

show("login",document.querySelector("nav button"));
</script>

</body>
</html>
